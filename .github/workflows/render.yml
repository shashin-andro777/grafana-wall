name: Render Grafana Panel to PNG

on:
  schedule:
    - cron: "*/1 * * * *"   # every 60 seconds
  workflow_dispatch:

permissions:
  contents: write

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Render PNG from Grafana
        run: |
          set -euo pipefail

          TOKEN="$(printf '%s' "${{ secrets.GRAFANA_TOKEN }}" | tr -d '\r\n')"
          BASE="$(printf '%s' "${{ secrets.GRAFANA_URL }}" | tr -d '\r\n')"
          DASH_UID="$(printf '%s' "${{ secrets.DASH_UID }}" | tr -d '\r\n')"
          DASH_SLUG="$(printf '%s' "${{ secrets.DASH_SLUG }}" | tr -d '\r\n')"

          ORG_ID="1"
          PANEL_ID="3"   # <-- change this if you want a different panel
          FROM="now-6h"
          TO="now"
          THEME="dark"

          WIDTH="1024"
          HEIGHT="768"

          URL="${BASE}/render/d-solo/${DASH_UID}/${DASH_SLUG}?orgId=${ORG_ID}&panelId=${PANEL_ID}&from=${FROM}&to=${TO}&width=${WIDTH}&height=${HEIGHT}&theme=${THEME}"

          echo "Rendering: $URL"

          curl -fSL \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "X-Grafana-Org-Id: ${ORG_ID}" \
            "$URL" \
            -o dashboard.png

          ls -lh dashboard.png

      - name: Commit updated image
        run: |
          git config user.name "grafana-wall-bot"
          git config user.email "actions@users.noreply.github.com"
          git add dashboard.png
          git commit -m "Update dashboard.png" || exit 0
          git push
