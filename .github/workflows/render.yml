name: Render Wall Dashboards (finance/health/misc)

on:
  schedule:
    - cron: "*/1 * * * *"   # every 60 seconds
  workflow_dispatch:

permissions:
  contents: write

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Render dashboard PNGs
        run: |
          set -euo pipefail

          TOKEN="$(printf '%s' "${{ secrets.GRAFANA_TOKEN }}" | tr -d '\r\n')"
          BASE="$(printf '%s' "${{ secrets.GRAFANA_URL }}" | tr -d '\r\n')"

          ORG_ID="1"
          FROM="now-6h"
          TO="now"
          THEME="dark"

          # Good default for wall screens. Adjust later if you want.
          WIDTH="1920"
          HEIGHT="1080"

          render_dash () {
            local DASH_UID_IN="$1"
            local DASH_SLUG_IN="$2"
            local OUT="$3"

            local DASH_UID_CLEAN
            local DASH_SLUG_CLEAN

            DASH_UID_CLEAN="$(printf '%s' "${DASH_UID_IN}" | tr -d '\r\n')"
            DASH_SLUG_CLEAN="$(printf '%s' "${DASH_SLUG_IN}" | tr -d '\r\n')"

            local URL="${BASE}/render/d/${DASH_UID_CLEAN}/${DASH_SLUG_CLEAN}?orgId=${ORG_ID}&from=${FROM}&to=${TO}&width=${WIDTH}&height=${HEIGHT}&theme=${THEME}"

            echo "Rendering -> ${OUT}"
            echo "URL(no token): ${URL}"

            HTTP_CODE="$(curl -sS -L \
              -H "Authorization: Bearer ${TOKEN}" \
              -H "X-Grafana-Org-Id: ${ORG_ID}" \
              -o "${OUT}" \
              -w "%{http_code}" \
              "${URL}")"

            echo "HTTP_CODE=${HTTP_CODE}"
            if [ "${HTTP_CODE}" != "200" ]; then
              echo "ERROR: HTTP ${HTTP_CODE} while rendering ${OUT}"
              exit 1
            fi

            # Fail if Grafana returned an error image
            if strings "${OUT}" | grep -qi "panel not found"; then
              echo "ERROR: '${OUT}' contains 'Panel not found' (check UID/SLUG secrets)."
              exit 1
            fi

            ls -lh "${OUT}"
          }

          # Render the 3 dashboards (UID/SLUG pulled from secrets)
          render_dash "${{ secrets.FIN_UID }}"    "${{ secrets.FIN_SLUG }}"    "finance.png"
          render_dash "${{ secrets.HEALTH_UID }}" "${{ secrets.HEALTH_SLUG }}" "health.png"
          render_dash "${{ secrets.MISC_UID }}"   "${{ secrets.MISC_SLUG }}"   "misc.png"

          echo "Rendered files:"
          ls -lh finance.png health.png misc.png

      - name: Commit updated images
        run: |
          set -euo pipefail

          git config user.name "grafana-wall-bot"
          git config user.email "actions@users.noreply.github.com"

          git add finance.png health.png misc.png

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Update wall PNGs"
          git push
