name: Render Grafana Panel to PNG

on:
  schedule:
    - cron: "*/1 * * * *"   # every 60 seconds
  workflow_dispatch:

permissions:
  contents: write

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Render PNG from Grafana (and verify)
        run: |
          set -euo pipefail

          # ---- Read secrets safely (strip CR/LF) ----
          TOKEN="$(printf '%s' "${{ secrets.GRAFANA_TOKEN }}" | tr -d '\r\n')"
          BASE="$(printf '%s' "${{ secrets.GRAFANA_URL }}" | tr -d '\r\n')"
          DASH_UID="$(printf '%s' "${{ secrets.DASH_UID }}" | tr -d '\r\n')"
          DASH_SLUG="$(printf '%s' "${{ secrets.DASH_SLUG }}" | tr -d '\r\n')"

          # ---- Settings ----
          ORG_ID="1"
          PANEL_ID="3"           # <- change this if you want a different panel
          FROM="now-6h"
          TO="now"
          THEME="dark"
          WIDTH="1024"
          HEIGHT="768"

          URL="${BASE}/render/d-solo/${DASH_UID}/${DASH_SLUG}?orgId=${ORG_ID}&panelId=${PANEL_ID}&from=${FROM}&to=${TO}&width=${WIDTH}&height=${HEIGHT}&theme=${THEME}"

          echo "---- Render request ----"
          echo "BASE=${BASE}"
          echo "DASH_UID=${DASH_UID}"
          echo "DASH_SLUG=${DASH_SLUG}"
          echo "ORG_ID=${ORG_ID}"
          echo "PANEL_ID=${PANEL_ID}"
          echo "URL(no token)=${URL}"
          echo "------------------------"

          # Render to a temp file first so we don't keep a stale dashboard.png on failures
          HTTP_CODE="$(curl -sS -L \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "X-Grafana-Org-Id: ${ORG_ID}" \
            -o dashboard.png.new \
            -w "%{http_code}" \
            "${URL}")"

          echo "HTTP_CODE=${HTTP_CODE}"
          if [ "${HTTP_CODE}" != "200" ]; then
            echo "ERROR: Grafana render returned HTTP ${HTTP_CODE}"
            exit 1
          fi

          echo "Rendered file info:"
          ls -lh dashboard.png.new
          date
          file dashboard.png.new || true

          # Fail hard if Grafana returned the error image
          if strings dashboard.png.new | grep -qi "panel not found"; then
            echo "ERROR: Grafana returned a PNG that contains 'Panel not found'."
            echo "Fix DASH_SLUG / DASH_UID / PANEL_ID / ORG_ID, then rerun."
            exit 1
          fi

          # Replace the published image
          mv dashboard.png.new dashboard.png

          # Ensure the file exists and show info
          echo "Final dashboard.png info:"
          ls -lh dashboard.png
          date

      - name: Commit + push dashboard.png
        run: |
          set -euo pipefail

          echo "Git status before add:"
          git status --porcelain

          git config user.name "grafana-wall-bot"
          git config user.email "actions@users.noreply.github.com"

          git add dashboard.png

          echo "Git status after add:"
          git status --porcelain

          # Commit only if there is a change
          if git diff --cached --quiet; then
            echo "No changes in dashboard.png; nothing to commit."
            exit 0
          fi

          git commit -m "Update dashboard.png"
          git push
