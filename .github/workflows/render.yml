name: Render Grafana Panels (separate PNGs)

on:
  schedule:
    - cron: "*/1 * * * *"   # every 60 seconds
  workflow_dispatch:

permissions:
  contents: write

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Render panels
        run: |
          set -euo pipefail

          TOKEN="$(printf '%s' "${{ secrets.GRAFANA_TOKEN }}" | tr -d '\r\n')"
          BASE="$(printf '%s' "${{ secrets.GRAFANA_URL }}" | tr -d '\r\n')"
          DASH_UID="$(printf '%s' "${{ secrets.DASH_UID }}" | tr -d '\r\n')"
          DASH_SLUG="$(printf '%s' "${{ secrets.DASH_SLUG }}" | tr -d '\r\n')"

          ORG_ID="1"
          FROM="now-6h"
          TO="now"
          THEME="dark"

          # Your panel IDs
          P3=3
          P4=4
          P5=5
          P6=6

          # Render size (iPad-friendly). Adjust if you want.
          W=1024
          H=768

          render_panel () {
            local PANEL_ID="$1"
            local OUT="$2"
            local URL="${BASE}/render/d-solo/${DASH_UID}/${DASH_SLUG}?orgId=${ORG_ID}&panelId=${PANEL_ID}&from=${FROM}&to=${TO}&width=${W}&height=${H}&theme=${THEME}"
            echo "Rendering ${OUT} from panelId=${PANEL_ID}"
            curl -fSL \
              -H "Authorization: Bearer ${TOKEN}" \
              -H "X-Grafana-Org-Id: ${ORG_ID}" \
              "${URL}" \
              -o "${OUT}"
            ls -lh "${OUT}"
          }

          render_panel "${P3}" "p3.png"
          render_panel "${P4}" "p4.png"
          render_panel "${P5}" "p5.png"
          render_panel "${P6}" "p6.png"

      - name: Commit PNGs
        run: |
          git config user.name "grafana-wall-bot"
          git config user.email "actions@users.noreply.github.com"
          git add p3.png p4.png p5.png p6.png
          git commit -m "Update panel PNGs" || exit 0
          git push
