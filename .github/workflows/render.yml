name: Render Full Dashboard (gridPos accurate, no blank space)

on:
  schedule:
    - cron: "*/1 * * * *"   # every 60 seconds
  workflow_dispatch:

permissions:
  contents: write

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install ImageMagick
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      - name: Render panels using gridPos and stitch (fills canvas)
        run: |
          set -euo pipefail

          # ---- Sanitize secrets (prevents hidden CR/LF issues) ----
          TOKEN="$(printf '%s' "${{ secrets.GRAFANA_TOKEN }}" | tr -d '\r\n')"
          BASE="$(printf '%s' "${{ secrets.GRAFANA_URL }}" | tr -d '\r\n')"
          DASH_UID="$(printf '%s' "${{ secrets.DASH_UID }}" | tr -d '\r\n')"
          DASH_SLUG="$(printf '%s' "${{ secrets.DASH_SLUG }}" | tr -d '\r\n')"



          FROM="now-6h"
          TO="now"
          THEME="dark"

          # ---- Target canvas (iPad Gen 1 landscape) ----
          CANVAS_W=1024
          CANVAS_H=768
          M=10   # outer margin

          # ---- Used grid size from your JSON (fills, no blank space) ----
          # Panels occupy columns 0..17 (18 wide) and rows 0..9 (10 tall)
          GRID_W=18
          GRID_H=10

          # ---- Panel gridPos from your JSON ----
          # id=3: x0  y0  w11 h5
          # id=4: x11 y0  w7  h5
          # id=5: x0  y5  w11 h5
          # id=6: x11 y5  w7  h5
          P3_X=0;  P3_Y=0;  P3_W=11; P3_H=5
          P4_X=11; P4_Y=0;  P4_W=7;  P4_H=5
          P5_X=0;  P5_Y=5;  P5_W=11; P5_H=5
          P6_X=11; P6_Y=5;  P6_W=7;  P6_H=5

          # Compute pixel rectangles from grid units
          python3 - <<'PY' > sizes.sh
          import os

          CANVAS_W = int(os.environ["CANVAS_W"])
          CANVAS_H = int(os.environ["CANVAS_H"])
          M        = int(os.environ["M"])
          GRID_W   = int(os.environ["GRID_W"])
          GRID_H   = int(os.environ["GRID_H"])

          unit_w = (CANVAS_W - 2*M) / GRID_W
          unit_h = (CANVAS_H - 2*M) / GRID_H

          def rect(name):
              x = int(os.environ[f"{name}_X"])
              y = int(os.environ[f"{name}_Y"])
              w = int(os.environ[f"{name}_W"])
              h = int(os.environ[f"{name}_H"])
              px = int(round(M + x * unit_w))
              py = int(round(M + y * unit_h))
              pw = max(1, int(round(w * unit_w)))
              ph = max(1, int(round(h * unit_h)))
              return px, py, pw, ph

          for name in ["P3", "P4", "P5", "P6"]:
              px, py, pw, ph = rect(name)
              print(f'export {name}_PX={px} {name}_PY={py} {name}_PW={pw} {name}_PH={ph}')
              print(f'echo "{name}: x={px} y={py} w={pw} h={ph}"')

          print(f'echo "Grid {GRID_W}x{GRID_H} -> canvas {CANVAS_W}x{CANVAS_H} (margin {M}), unit_w={unit_w:.4f}, unit_h={unit_h:.4f}"')
          PY

          source sizes.sh

          render_panel () {
            local PANEL_ID="$1"
            local OUT="$2"
            local W="$3"
            local H="$4"
            local URL="${BASE}/render/d-solo/${DASH_UID}/${DASH_SLUG}?orgId=1&panelId=${PANEL_ID}&from=${FROM}&to=${TO}&width=${W}&height=${H}&theme=${THEME}"
            echo "Rendering panel ${PANEL_ID} -> ${OUT} (${W}x${H})"
            curl -fSL -H "Authorization: Bearer ${TOKEN}" "${URL}" -o "${OUT}"
          }

          # Render each panel at its computed pixel size
          render_panel 3 p3.png "${P3_PW}" "${P3_PH}"
          render_panel 4 p4.png "${P4_PW}" "${P4_PH}"
          render_panel 5 p5.png "${P5_PW}" "${P5_PH}"
          render_panel 6 p6.png "${P6_PW}" "${P6_PH}"

          # Stitch onto a black canvas
          convert -size ${CANVAS_W}x${CANVAS_H} xc:black canvas.png

          convert canvas.png \
            \( p3.png \) -geometry +${P3_PX}+${P3_PY} -composite \
            \( p4.png \) -geometry +${P4_PX}+${P4_PY} -composite \
            \( p5.png \) -geometry +${P5_PX}+${P5_PY} -composite \
            \( p6.png \) -geometry +${P6_PX}+${P6_PY} -composite \
            dashboard.png

          ls -lh dashboard.png

      - name: Commit updated image
        run: |
          git config user.name "grafana-wall-bot"
          git config user.email "actions@users.noreply.github.com"
          git add dashboard.png
          git commit -m "Update dashboard.png (gridPos v11)" || exit 0
          git push
