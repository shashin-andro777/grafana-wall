name: Render Full Dashboard (4-panel grid)

on:
  schedule:
    - cron: "*/1 * * * *"   # every 60 seconds
  workflow_dispatch:

permissions:
  contents: write

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install ImageMagick
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      - name: Render 4 panels + stitch into dashboard.png
        run: |
          set -euo pipefail

          # ---- Sanitize secrets (avoids hidden newline issues) ----
          TOKEN="$(printf '%s' "${{ secrets.GRAFANA_TOKEN }}" | tr -d '\r\n')"
          BASE="$(printf '%s' "${{ secrets.GRAFANA_URL }}" | tr -d '\r\n')"
          UID="$(printf '%s' "${{ secrets.DASH_UID }}" | tr -d '\r\n')"
          SLUG="$(printf '%s' "${{ secrets.DASH_SLUG }}" | tr -d '\r\n')"

          # ---- Time range / theme ----
          FROM="now-6h"
          TO="now"
          THEME="dark"

          # ---- Your panel IDs ----
          P_FINANCES=3
          P_WEIGHT_TOP=4
          P_YOUTUBE=5
          P_WEIGHT_BOTTOM=6

          # ---- Panel render size (2x2 grid -> final ~1024x768) ----
          # Each panel 512x384, combined -> 1024x768
          W=512
          H=384

          render_panel () {
            local PANEL_ID="$1"
            local OUT="$2"
            local URL="${BASE}/render/d-solo/${UID}/${SLUG}?orgId=1&panelId=${PANEL_ID}&from=${FROM}&to=${TO}&width=${W}&height=${H}&theme=${THEME}"
            echo "Rendering panel ${PANEL_ID} -> ${OUT}"
            curl -fSL -H "Authorization: Bearer ${TOKEN}" "${URL}" -o "${OUT}"
          }

          render_panel "${P_FINANCES}"      p1.png
          render_panel "${P_WEIGHT_TOP}"    p2.png
          render_panel "${P_YOUTUBE}"       p3.png
          render_panel "${P_WEIGHT_BOTTOM}" p4.png

          # ---- Stitch into a single dashboard.png (2x2) ----
          montage p1.png p2.png p3.png p4.png \
            -tile 2x2 \
            -geometry +0+0 \
            dashboard.png

          echo "Final stitched image:"
          ls -lh dashboard.png

      - name: Commit updated image
        run: |
          git config user.name "grafana-wall-bot"
          git config user.email "actions@users.noreply.github.com"
          git add dashboard.png
          git commit -m "Update dashboard.png" || exit 0
          git push
