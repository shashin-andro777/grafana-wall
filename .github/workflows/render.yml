name: Render Grafana Panels (rotating PNGs)

on:
  schedule:
    - cron: "*/1 * * * *"   # every 60 seconds
  workflow_dispatch:

permissions:
  contents: write

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Render panel PNGs
        run: |
          set -euo pipefail

          TOKEN="$(printf '%s' "${{ secrets.GRAFANA_TOKEN }}" | tr -d '\r\n')"
          BASE="$(printf '%s' "${{ secrets.GRAFANA_URL }}" | tr -d '\r\n')"
          DASH_UID="$(printf '%s' "${{ secrets.DASH_UID }}" | tr -d '\r\n')"
          DASH_SLUG="$(printf '%s' "${{ secrets.DASH_SLUG }}" | tr -d '\r\n')"

          ORG_ID="1"
          FROM="now-6h"
          TO="now"
          THEME="dark"
          WIDTH="1024"
          HEIGHT="768"

          render_panel () {
            local PANEL_ID="$1"
            local OUT="$2"
            local URL="${BASE}/render/d-solo/${DASH_UID}/${DASH_SLUG}?orgId=${ORG_ID}&panelId=${PANEL_ID}&from=${FROM}&to=${TO}&width=${WIDTH}&height=${HEIGHT}&theme=${THEME}"

            echo "Rendering panel ${PANEL_ID} â†’ ${OUT}"
            curl -fSL \
              -H "Authorization: Bearer ${TOKEN}" \
              -H "X-Grafana-Org-Id: ${ORG_ID}" \
              "${URL}" \
              -o "${OUT}"

            if strings "${OUT}" | grep -qi "panel not found"; then
              echo "ERROR: Panel ${PANEL_ID} returned 'Panel not found'"
              exit 1
            fi
          }

          # ---- YOUR PANEL IDS ----
          render_panel 3 p3.png
          render_panel 4 p4.png
          render_panel 5 p5.png
          render_panel 6 p6.png

          ls -lh p3.png p4.png p5.png p6.png

      - name: Commit updated PNGs
        run: |
          set -euo pipefail
          git config user.name "grafana-wall-bot"
          git config user.email "actions@users.noreply.github.com"

          git add p3.png p4.png p5.png p6.png

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Update panel PNGs"
          git push
